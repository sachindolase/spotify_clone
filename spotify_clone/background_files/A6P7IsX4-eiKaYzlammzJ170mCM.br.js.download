var StoPrv;(function(n){var t=function(){function t(){var t=this;this.storyViewer=null;this.configMap={};this.currentKData=null;this.minHoverDelay=300;this.dwellStartTime=null;this.onClick=function(i){var r=t.currentConfig,u=t.storyViewer,f,e,o;if(t.hoverContainer&&r&&u&&t.currentHoveredElement){if(f=u.activeSlideIdx,e=u.slides[f],r.ClickCallback)r.ClickCallback(t.currentHoveredElement,r.HoverContainerId,f);else if(r.ClickElementClass&&t.currentClickEventElement)t.currentClickEventElement.click();else return;o=sj_et(i);t.captionContainer.contains(o)?StoPrvInst.logClickEvent("StoryPreviewTitle",-1,-1,n.MediaType.Unknown,r.HoverContainerId,t.currentKData,r.FeatureId):StoPrvInst.logClickEvent("StoryPreviewSlide",f,u.slides.length,e.type,r.HoverContainerId,t.currentKData,r.FeatureId)}};this.onUnload=function(){sj_ue(_w,n.UnloadEvent,t.onUnload);sj_ue(_d,n.MouseOverEvent,t.onMouseOver);sj_evt.unbind(n.AjaxUnloadEvent,t.onUnload);t.unbindHoverContainerEvents();t.removeHoverContainerFromDocument();t.clearAllStorageVariables()};this.onMouseOver=function(i){t.stopHoverDelayTimeout();t.hoverDelayTimeout=sb_st(function(){var e,r=t.findElement(sj_et(i),function(t){return t.hasAttribute(n.StoryMetadataAttr)}),f,o,u;if(r&&r!=t.currentHoveredElement&&(f=t.getStoryData(r),f)&&(o=t.getHoverTargetContainer(r),u=t.getStoryPreviewConfig(o),u)&&((e=f.slides)===null||e===void 0?void 0:e.length)>0){t.currentConfig=u;t.currentStoryData=f;t.currentHoveredElement=r;t.currentClickEventElement=u.ClickElementClass?t.findElement(sj_et(i),function(n){return n.className===u.ClickElementClass}):null;t.onHoverImmediate(r,f,u)}},t.minHoverDelay)};this.onMouseOut=function(i){var r,u,f,e,o,s,h,l=t.findElement(sj_mo(i),function(t){return t.hasAttribute(n.StoryMetadataAttr)}),c;l==null&&(sj_ue(_d,n.MouseOutEvent,t.onMouseOut),t.dwellStartTime&&(c={DwellTime:(new Date).getTime()-t.dwellStartTime,TotalSlideCt:(u=(r=t.storyViewer)===null||r===void 0?void 0:r.slides)===null||u===void 0?void 0:u.length,SlideViewCt:(f=t.storyViewer)===null||f===void 0?void 0:f.slideViewCt,RenderDelay:(e=t.storyViewer)===null||e===void 0?void 0:e.renderDelay},StoPrvInst.logInfo("PopupClose",c,(o=t.currentConfig)===null||o===void 0?void 0:o.HoverContainerId,t.currentKData,(s=t.currentConfig)===null||s===void 0?void 0:s.FeatureId)),(h=t.storyViewer)===null||h===void 0?void 0:h.clear(),t.stopHoverDelayTimeout(),t.removeHoverContainerFromDocument(),t.clearAllStorageVariables())};sj_be(_d,n.MouseOverEvent,this.onMouseOver);sj_be(_d,n.UnloadEvent,this.onUnload);sj_evt.bind(n.AjaxUnloadEvent,this.onUnload);this.storyViewer=new n.SlideShow}return t.prototype.register=function(t){if(t&&t.HoverContainerId&&t.HoverTargetClass){var i=_qs("#"+t.HoverContainerId);i&&(this.configMap[t.HoverContainerId]||(this.configMap[t.HoverContainerId]=t,this.minHoverDelay=this.minHoverDelay?Math.min(this.minHoverDelay,t.HoverDelay):t.HoverDelay,i.setAttribute(n.HoverTargetContainerAttr,t.HoverContainerId)))}},t.prototype.registerClickCallback=function(n,t){if(n&&t){var i=this.configMap[n];i&&(i.ClickCallback=t)}},t.prototype.unbindHoverContainerEvents=function(){var i=this.currentConfig,t;if(i&&(t=_qs(i.HoverContainerId),t)){sj_ue(t,n.ClickEvent,this.onClick);return}},t.prototype.getHoverContainerLayout=function(){var t=this.currentHoveredElement;if(t){var n=t.getBoundingClientRect(),i={w:n.width,h:n.height},r={left:n.left,top:n.top},u=this.getHoverContainerSize(i);return{startSize:i,startPos:r,targetSize:u}}},t.prototype.getHoverContainerSize=function(t){var i=this.currentConfig,s=this.currentStoryData,o=this.currentHoveredElement,f,e,r,u;return!o||!i||!s?null:(f=+o.getAttribute(n.HoverContainerWidthAttr),e=+o.getAttribute(n.HoverContainerHeightAttr),f&&e&&f>0&&e>0)?{w:f,h:e}:i.EnableFixedSize&&i.FixedWidth&&i.FixedHeight?{w:i.FixedWidth,h:i.FixedHeight}:(r=t.w*i.ScaleFactor,u=t.h*i.ScaleFactor,r<i.MinWidth&&(r=i.MinWidth,u=t.h*r/t.w,u>i.MaxHeight&&(u=i.MaxHeight)),{w:Math.floor(r),h:Math.floor(u)})},t.prototype.getHoverTargetContainer=function(t){for(var i=t;i!=null;){if(i.hasAttribute(n.HoverTargetContainerAttr))return i;if(i==this.hoverContainer)return this.currentHoveredElement;i=i.parentElement&&i.parentElement!=i?i.parentElement:null}return null},t.prototype.getStoryPreviewConfig=function(t){if(!t)return null;var i=t.getAttribute(n.HoverTargetContainerAttr);return!i||!this.configMap[i]?null:this.configMap[i]},t.prototype.getStoryData=function(t){var r=t.getAttribute(n.StoryMetadataAttr),i;try{i=JSON.parse(r)}catch(u){return null}return i},t.prototype.findElement=function(n,t){while(n!=null&&n instanceof HTMLElement){if(n==this.hoverContainer)return this.currentHoveredElement;if(typeof n.hasAttribute=="function"&&t(n))return n;n=n.parentElement&&n.parentElement!=n?n.parentElement:null}return null},t.prototype.stopHoverDelayTimeout=function(){this.hoverDelayTimeout!=null&&(sb_ct(this.hoverDelayTimeout),this.hoverDelayTimeout=null)},t.prototype.onHoverImmediate=function(n,t,i){var r=this;this.currentHoveredElement&&t&&i&&this.currentHoveredElement==n&&(this.stopHoverDelayTimeout(),this.setKData(n),this.minHoverDelay>=i.HoverDelay?this.renderHoverContainer(t,i):this.hoverDelayTimeout=sb_st(function(){r.renderHoverContainer(t,i)},i.HoverDelay-this.minHoverDelay))},t.prototype.renderHoverContainer=function(t,i){var r=this;if(this.currentHoveredElement&&t&&i){this.hoverContainer||this.createHoverContainer();sj_be(_d,n.MouseOutEvent,this.onMouseOut);var u=function(){var t,f;i.EnableScaleAnimation&&(sj_ue(r.hoverContainer,n.TransitionEndEvent,u),r.hoverContainer.classList.remove(n.AnimateImageClassName),r.storyViewerContainer.classList.remove(n.AnimateImageClassName));StoPrvInst.logInteractionEvent("PopupOpen",null,(t=r.currentConfig)===null||t===void 0?void 0:t.HoverContainerId,r.currentKData,(f=r.currentConfig)===null||f===void 0?void 0:f.FeatureId);r.dwellStartTime=Date.now()},f=this.getHoverContainerLayout(),e=f.targetSize;this.addHoverContainerToDocument();this.setHoverContainerContent(t);this.resizeAndRepositionHoverContainer(f,u);this.setHoverContainerCaptions(t,i);this.setContainerSize(this.hoverContainer,{w:e.w,h:e.h+this.captionContainer.clientHeight})}},t.prototype.setHoverContainerCaptions=function(t,i){var u,r;if(t&&i){while(this.captionContainer.lastChild)this.captionContainer.removeChild(this.captionContainer.lastChild);t.title&&t.title.length>0?(u=sj_ce("span"),u.appendChild(_d.createTextNode(t.title)),r=sj_ce("a",null,"stotitle"),r.appendChild(u),this.captionContainer.appendChild(r),sj_be(r,n.ClickEvent,this.onClick)):this.captionContainer.style.display="none"}},t.prototype.createHoverContainer=function(){this.hoverContainer||(this.storyViewerContainer=sj_ce("div","stpview","stpview"),sj_be(this.storyViewerContainer,n.ClickEvent,this.onClick),this.captionContainer=sj_ce("div",null,"stocap"),this.hoverContainer=sj_ce("div",n.HoverContainerViewId,n.HoverContainerClass),this.hoverContainer.style.visibility="hidden",this.hoverContainer.setAttribute("data-priority","2"),this.hoverContainer.appendChild(this.storyViewerContainer),this.hoverContainer.appendChild(this.captionContainer),(_w.location.href.indexOf("testhooks=1")>-1||_w.location.href.indexOf("testhooks=~1")>-1)&&this.hoverContainer.setAttribute("data-tag","multimedia.StoryPreviewHover"))},t.prototype.setHoverContainerContent=function(n){var t,i=this.currentConfig;i&&this.hoverContainer&&this.storyViewerContainer&&(this.hoverContainer.style.background=i.HoverBackgroundColor,(t=this.storyViewer)===null||t===void 0?void 0:t.renderAsync("stpview",n,i,this.currentKData))},t.prototype.resizeAndRepositionHoverContainer=function(t,i){var o=this.hoverContainer,u=this.currentConfig;if(o&&u){var r=t.startSize,e=t.startPos,f=t.targetSize;u.EnableScaleAnimation&&(sj_be(this.hoverContainer,n.TransitionEndEvent,i),this.setHoverContainerPosition(r,r,e),this.setContainerSize(this.hoverContainer,r),this.setContainerSize(this.storyViewerContainer,r),this.hoverContainer.classList.add(n.AnimateImageClassName),this.storyViewerContainer.classList.add(n.AnimateImageClassName));this.setHoverContainerPosition(f,r,e);this.setContainerSize(this.storyViewerContainer,f);this.setContainerSize(this.hoverContainer,f);u.EnableScaleAnimation||i()}},t.prototype.setHoverContainerPosition=function(t,i,r){if(this.hoverContainer&&this.currentHoveredElement){var u=_w.scrollX||sb_de.scrollLeft,f=_w.scrollY||sb_de.scrollTop,e=r.left+u,o=r.top+f,s=e-(t.w-i.w)/2,h=o-(t.h-i.h)/2;this.hoverContainer.style.left=Math.floor(s)+n.PixelStr;this.hoverContainer.style.top=Math.floor(h)+n.PixelStr}},t.prototype.setContainerSize=function(t,i){if(t&&i){var r=t.style;r.height=i.h+n.PixelStr;r.width=i.w+n.PixelStr}},t.prototype.addHoverContainerToDocument=function(){this.hoverContainer&&(this.hoverContainer.style.visibility="visible",_d.body.appendChild(this.hoverContainer))},t.prototype.removeHoverContainerFromDocument=function(){var n,t;this.hoverContainer&&((t=(n=this.hoverContainer)===null||n===void 0?void 0:n.parentNode)===null||t===void 0?void 0:t.removeChild(this.hoverContainer))},t.prototype.clearAllStorageVariables=function(){this.currentHoveredElement=null;this.hoverContainer=null;this.captionContainer=null;this.currentStoryData=null;this.currentConfig=null;this.dwellStartTime=null;this.currentKData=null},t.prototype.setKData=function(n){n&&StoPrvInst.initialized&&(this.currentKData=StoPrvInst.getInstKData(n),!this.currentKData)},t}();n.StoPrvHv=t})(StoPrv||(StoPrv={}))